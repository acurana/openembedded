From 86d6366dfb478a8e12a424baea118f49706bf88e Mon Sep 17 00:00:00 2001
From: Ulf Samuelsson <ulf.samuelsson@atmel.com>
Date: Sun, 16 Jan 2011 11:32:26 +0100
Subject: [PATCH 3/3] Enable SD-Card boot for SAM9M10/G45 boards

---
 Makefile                                           |   10 ++-
 .../cpu/arm926ejs/at91/at91sam9m10g45_devices.c    |   13 ++++
 arch/arm/include/asm/arch-at91/hardware.h          |    1 +
 board/atmel/at91sam9m10g45ek/at91sam9m10g45ek.c    |   35 +++++++++-
 include/configs/at91sam9m10g45ek.h                 |   74 +++++++++++++++-----
 5 files changed, 110 insertions(+), 23 deletions(-)

diff --git a/Makefile b/Makefile
index 3cd696c..40a288d 100644
--- a/Makefile
+++ b/Makefile
@@ -861,22 +861,26 @@ CPU9260_config	:	unconfig
 at91sam9m10g45ek_nandflash_config \
 at91sam9m10g45ek_dataflash_config \
 at91sam9m10g45ek_dataflash_cs0_config \
+at91sam9m10g45ek_sd_config \
 at91sam9m10g45ek_config \
 at91sam9g45ekes_nandflash_config \
 at91sam9g45ekes_dataflash_config \
 at91sam9g45ekes_dataflash_cs0_config \
+at91sam9g45ekes_sd_config \
 at91sam9g45ekes_config	:	unconfig
 	@mkdir -p $(obj)include
-		@if [ "$(findstring 9m10,$@)" ] ; then \
+	@if [ "$(findstring 9m10,$@)" ] ; then \
 		echo "#define CONFIG_AT91SAM9M10G45EK 1"	>>$(obj)include/config.h ; \
 	else \
-		echo "#define CONFIG_AT91SAM9G45EKES 1"	>>$(obj)include/config.h ; \
+		echo "#define CONFIG_AT91SAM9G45EKES 1"		>>$(obj)include/config.h ; \
 	fi;
 	@if [ "$(findstring _nandflash,$@)" ] ; then \
 		echo "#define CONFIG_SYS_USE_NANDFLASH 1"	>>$(obj)include/config.h ; \
+	elif [ "$(findstring _sd,$@)" ] ; then \
+		echo "#define CONFIG_SYS_USE_SD_CARD 1"		>>$(obj)include/config.h ; \
 	else \
 		echo "#define CONFIG_SYS_USE_DATAFLASH 1"	>>$(obj)include/config.h ; \
-		echo "#define CONFIG_ATMEL_SPI 1"	>>$(obj)include/config.h ; \
+		echo "#define CONFIG_ATMEL_SPI 1"		>>$(obj)include/config.h ; \
 	fi;
 	@$(MKCONFIG) -n $@ -a at91sam9m10g45ek arm arm926ejs at91sam9m10g45ek atmel at91
 
diff --git a/arch/arm/cpu/arm926ejs/at91/at91sam9m10g45_devices.c b/arch/arm/cpu/arm926ejs/at91/at91sam9m10g45_devices.c
index 4ad9b1f..229113d 100644
--- a/arch/arm/cpu/arm926ejs/at91/at91sam9m10g45_devices.c
+++ b/arch/arm/cpu/arm926ejs/at91/at91sam9m10g45_devices.c
@@ -185,3 +185,16 @@ void at91_macb_hw_init(void)
 #endif
 }
 #endif
+
+#if defined(CONFIG_GENERIC_ATMEL_MCI)
+void	at91_mci_hw_init()
+{
+	at91_set_A_periph(AT91_PIN_PA0, 0);	/* MCI0_CK */
+	at91_set_A_periph(AT91_PIN_PA1, 0);	/* MCI0_CDA */
+	at91_set_A_periph(AT91_PIN_PA2, 0);	/* MCI0_DA0 */
+	at91_set_A_periph(AT91_PIN_PA3, 0);	/* MCI0_DA1 */
+	at91_set_A_periph(AT91_PIN_PA4, 0);	/* MCI0_DA2 */
+	at91_set_A_periph(AT91_PIN_PA5, 0);	/* MCI0_DA3 */
+}
+#endif
+
diff --git a/arch/arm/include/asm/arch-at91/hardware.h b/arch/arm/include/asm/arch-at91/hardware.h
index d701dc0..be92365 100644
--- a/arch/arm/include/asm/arch-at91/hardware.h
+++ b/arch/arm/include/asm/arch-at91/hardware.h
@@ -43,6 +43,7 @@
 #define AT91_ID_UHP	AT91SAM9RL_ID_UHP
 #elif defined(CONFIG_AT91SAM9G45) || defined(CONFIG_AT91SAM9M10G45)
 #include <asm/arch/at91sam9g45.h>
+#define AT91_BASE_MCI	AT91SAM9G45_BASE_MCI0
 #define AT91_BASE_EMAC  AT91SAM9G45_BASE_EMAC
 #define AT91_BASE_SPI   AT91SAM9G45_BASE_SPI0
 #define AT91_BASE_SPI1  AT91SAM9G45_BASE_SPI1
diff --git a/board/atmel/at91sam9m10g45ek/at91sam9m10g45ek.c b/board/atmel/at91sam9m10g45ek/at91sam9m10g45ek.c
index f92b20f..0711353 100644
--- a/board/atmel/at91sam9m10g45ek/at91sam9m10g45ek.c
+++ b/board/atmel/at91sam9m10g45ek/at91sam9m10g45ek.c
@@ -36,13 +36,17 @@
 #include <asm/arch/hardware.h>
 #include <lcd.h>
 #include <atmel_lcdc.h>
+#ifdef CONFIG_GENERIC_ATMEL_MCI
+# include <mmc.h>
+#endif
+
 #if defined(CONFIG_RESET_PHY_R) && defined(CONFIG_MACB)
 #include <net.h>
 #endif
 #include <netdev.h>
 
-DECLARE_GLOBAL_DATA_PTR;
 
+DECLARE_GLOBAL_DATA_PTR;
 /* ------------------------------------------------------------------------- */
 /*
  * Miscelaneous platform dependent initialisations
@@ -243,6 +247,35 @@ void lcd_show_board_info(void)
 #endif /* CONFIG_LCD_INFO */
 #endif
 
+
+#ifdef CONFIG_GENERIC_ATMEL_MCI
+/* this is a weak define that we are overriding */
+int board_mmc_init(bd_t *bd)
+{
+	/* Enable clock */
+	at91_sys_write(AT91_PMC_PCER, 1 << AT91SAM9G45_ID_MCI0);
+	at91_mci_hw_init();
+
+	/* This calls the atmel_mci_init in gen_atmel_mci.c */
+	return atmel_mci_init((void *)AT91_BASE_MCI);
+}
+
+/* this is a weak define that we are overriding */
+int board_mmc_getcd(u8 *cd, struct mmc *mmc)
+{
+	/*
+	 * the only currently existing use of this function
+	 * (fsl_esdhc.c) suggests this function must return
+	 * *cs = TRUE if a card is NOT detected -> in most
+	 * cases the value of the pin when the detect switch
+	 * closes to GND
+	 */
+	*cd = at91_get_gpio_value (CONFIG_SYS_MMC_CD_PIN) ? 1 : 0;
+	return 0;
+}
+
+#endif
+
 int board_init(void)
 {
 	/* Enable Ctrlc */
diff --git a/include/configs/at91sam9m10g45ek.h b/include/configs/at91sam9m10g45ek.h
index 63fa11c..d7c958d 100644
--- a/include/configs/at91sam9m10g45ek.h
+++ b/include/configs/at91sam9m10g45ek.h
@@ -97,7 +97,13 @@
 #undef CONFIG_CMD_IMI
 #undef CONFIG_CMD_IMLS
 #undef CONFIG_CMD_LOADS
-#undef CONFIG_CMD_SOURCE
+#define CONFIG_CMD_SOURCE
+#undef CONFIG_CMD_XIMG
+#define CONFIG_CMD_ASKENV
+#define CONFIG_CMD_EXT2
+#define CONFIG_CMD_FAT
+#undef CONFIG_CMD_JFFS2
+#define CONFIG_CMD_MMC
 
 #define CONFIG_CMD_PING		1
 #define CONFIG_CMD_DHCP		1
@@ -123,6 +129,7 @@
 #define CONFIG_SYS_DATAFLASH_LOGIC_ADDR_CS0	0xC0000000	/* CS0 */
 #define CONFIG_SYS_DATAFLASH_LOGIC_ADDR_CS1	0xD0000000	/* CS1 */
 #define AT91_SPI_CLK				15000000
+#define	AT91_SPI_MODE				AT91_SPI_MODE3
 #define DATAFLASH_TCSS				(0x1a << 16)
 #define DATAFLASH_TCHS				(0x01 << 24)
 #endif
@@ -155,6 +162,15 @@
 
 #endif
 
+/* SD/MMC card */
+#define CONFIG_MMC				1
+#define CONFIG_GENERIC_MMC			1
+#define CONFIG_GENERIC_ATMEL_MCI		1
+#undef	CONFIG_ATMEL_MCI_PORTB
+#define CONFIG_SYS_MMC_CD_PIN			AT91_PIN_PD10
+#define CONFIG_SUPPORT_VFAT
+
+
 /* Ethernet */
 #define CONFIG_MACB				1
 #define CONFIG_RMII				1
@@ -172,26 +188,26 @@
 #define CONFIG_SYS_USB_OHCI_MAX_ROOT_PORTS	2
 #define CONFIG_USB_STORAGE			1
 
-#define CONFIG_SYS_LOAD_ADDR			0x22000000	/* load address */
+#define CONFIG_SYS_LOAD_ADDR			0x72000000	/* load address */
 
 #define CONFIG_SYS_MEMTEST_START		PHYS_SDRAM
-#define CONFIG_SYS_MEMTEST_END			0x23e00000
+#define CONFIG_SYS_MEMTEST_END			PHYS_SDRAM + PHYS_SDRAM_SIZE
 
 #ifdef CONFIG_SYS_USE_DATAFLASH
 
 /* bootstrap + u-boot + env + linux in dataflash on CS0 */
 #define	CONFIG_ENV_IS_IN_DATAFLASH	1
 /* #define CONFIG_ENV_IS_IN_SPI_FLASH	1 */
-#define CONFIG_SYS_MONITOR_BASE	(0xC0000000 + 0x8400)
+#define CONFIG_SYS_MONITOR_BASE		(0xC0000000 + 0x8400)
 #define CONFIG_ENV_OFFSET		0x4200
-#define CONFIG_ENV_ADDR		(0xC0000000 + CONFIG_ENV_OFFSET)
-#define CONFIG_ENV_SIZE		0x4200
+#define CONFIG_ENV_ADDR			(0xC0000000 + CONFIG_ENV_OFFSET)
+#define CONFIG_ENV_SIZE			0x4200
 #define CONFIG_ENV_SECT_SIZE		0x4200
-#define CONFIG_BOOTCOMMAND	"cp.b 0xC0042000 0x72000000 0x290000; bootm 0x72000000"
-#define CONFIG_BOOTARGS		"console=ttyS0,115200 " \
-				"root=/dev/mtdblock1 " \
-				"mtdparts=atmel_nand:4M(unused)ro,-(root) "\
-				"rw rootfstype=jffs2"
+#define CONFIG_BOOTCOMMAND		"cp.b 0xC0042000 0x72000000 0x290000; bootm 0x72000000"
+#define CONFIG_BOOTARGS			"console=ttyS0,115200 " \
+					"root=/dev/mtdblock1 " \
+					"mtdparts=atmel_nand:4M(unused)ro,-(root) "\
+					"rw rootfstype=jffs2"
 #endif
 
 #ifdef CONFIG_SYS_USE_NANDFLASH
@@ -200,14 +216,34 @@
 #define CONFIG_ENV_IS_IN_NAND	1
 #define CONFIG_ENV_OFFSET		0x60000
 #define CONFIG_ENV_OFFSET_REDUND	0x80000
-#define CONFIG_ENV_SIZE		0x20000		/* 1 sector = 128 kB */
-#define CONFIG_BOOTCOMMAND	"nand read 0x72000000 0x200000 0x200000; bootm"
-#define CONFIG_BOOTARGS		"console=ttyS0,115200 " \
-				"root=/dev/mtdblock5 " \
-				"mtdparts=atmel_nand:128k(bootstrap)ro, \
-				256k(uboot)ro,128k(env1)ro,128k(env2)ro, \
-				2M(linux),-(root) " \
-				"rw rootfstype=jffs2"
+#define CONFIG_ENV_SIZE			0x20000		/* 1 sector = 128 kB */
+#define CONFIG_BOOTCOMMAND		"nand read 0x72000000 0x200000 0x200000; bootm"
+#define CONFIG_BOOTARGS			"console=ttyS0,115200 " \
+					"root=/dev/mtdblock5 " \
+					"mtdparts=atmel_nand:128k(bootstrap)ro, \
+					256k(uboot)ro,128k(env1)ro,128k(env2)ro, \
+					2M(linux),-(root) " \
+					"rw rootfstype=jffs2"
+
+#endif
+
+#ifdef	CONFIG_SYS_USE_SD_CARD
+#define	CONFIG_ENV_IS_NOWHERE
+#define CONFIG_ENV_SIZE			0x10000
+#define CONFIG_EXTRA_ENV_SETTINGS	\
+					"load_env=fatload mmc 0:1 0x70000000 u-boot.env ; source 0x70000000 \0"	\
+					"load_kernel=fatload mmc 0:1 0x72000000 uimage\0"	\
+					"at91sam9m10ekes=9cd\0"	\
+					"at91sam9g45ekes=8a4\0"	\
+					"at91sam9m10g45ek=726\0"	\
+					"machid=726\0"
+
+#define CONFIG_BOOTCOMMAND		"mmc init; run load_env ; run load_kernel ; bootm 0x72000000"
+#define CONFIG_BOOTARGS			"mem=128M "	\
+					"console=ttyS0,115200 " \
+					"root=/dev/mmcblk0p2 " \
+					"rootdelay=2 "\
+					"rootfstype=rootfs rw"
 
 #endif
 
-- 
1.7.1

